<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agora MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .farm-product-group {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .farm-section.expanded .farm-product-group {
            max-height: 2000px; /* Adjust as needed */
        }
        .farm-section .transition-transform {
             transition: transform 0.3s ease;
        }
        .farm-section.expanded .transition-transform {
            transform: rotate(180deg);
        }
        /* Custom animation for notifications */
        @keyframes slide-in-out {
            0% { transform: translateY(-100%); opacity: 0; }
            10% { transform: translateY(0); opacity: 1; }
            90% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100%); opacity: 0; }
        }
        .notification {
            animation: slide-in-out 4s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Notification Area -->
    <div id="notification-area" class="fixed top-5 right-5 z-50"></div>

    <!-- Main Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-2xl font-bold text-green-700 cursor-pointer" onclick="app.navigateTo('home')">Agora</span>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div id="desktop-nav-links" class="ml-10 flex items-baseline space-x-4">
                        <a href="#" class="nav-link text-gray-600 hover:bg-green-600 hover:text-white px-3 py-2 rounded-md text-sm font-medium" onclick="app.navigateTo('marketplace'); return false;">Marketplace</a>
                        <a href="#" class="nav-link text-gray-600 hover:bg-green-600 hover:text-white px-3 py-2 rounded-md text-sm font-medium" onclick="app.navigateTo('events'); return false;">Events</a>
                        <a href="#" class="nav-link text-gray-600 hover:bg-green-600 hover:text-white px-3 py-2 rounded-md text-sm font-medium" onclick="app.navigateTo('farmer-login'); return false;">Farmer Portal</a>
                        <a id="nav-account-link" href="#" class="nav-link text-gray-600 hover:bg-green-600 hover:text-white px-3 py-2 rounded-md text-sm font-medium" onclick="app.handleAccountClick(); return false;">Login</a>
                        <a href="#" class="relative text-gray-600 hover:bg-green-600 hover:text-white px-3 py-2 rounded-md text-sm font-medium" onclick="app.navigateTo('cart'); return false;">
                            <span>Cart</span>
                            <span id="cart-item-count" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </a>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-button" class="bg-gray-100 inline-flex items-center justify-center p-2 rounded-md text-gray-500"><span class="sr-only">Open main menu</span><svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg><svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
            </div>
        </div>
        <div class="md:hidden" id="mobile-menu" style="display: none;">
            <div id="mobile-nav-links" class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                 <a href="#" class="text-gray-600 hover:bg-green-600 hover:text-white block px-3 py-2 rounded-md text-base font-medium" onclick="app.navigateTo('marketplace'); return false;">Marketplace</a>
                 <a href="#" class="text-gray-600 hover:bg-green-600 hover:text-white block px-3 py-2 rounded-md text-base font-medium" onclick="app.navigateTo('events'); return false;">Events</a>
                <a href="#" class="text-gray-600 hover:bg-green-600 hover:text-white block px-3 py-2 rounded-md text-base font-medium" onclick="app.navigateTo('farmer-login'); return false;">Farmer Portal</a>
                <a id="mobile-nav-account-link" href="#" class="text-gray-600 hover:bg-green-600 hover:text-white block px-3 py-2 rounded-md text-base font-medium" onclick="app.handleAccountClick(); return false;">Login</a>
                <a href="#" class="relative text-gray-600 hover:bg-green-600 hover:text-white block px-3 py-2 rounded-md text-base font-medium" onclick="app.navigateTo('cart'); return false;">
                    <span>Cart</span><span id="mobile-cart-item-count" class="ml-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 inline-flex items-center justify-center">0</span>
                </a>
            </div>
        </div>
    </nav>

    <main>
        <!-- Home Page -->
        <div id="home-page" class="page active">
            <div class="relative bg-white overflow-hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="relative z-10 pb-8 bg-white sm:pb-16 md:pb-20 lg:max-w-2xl lg:w-full lg:pb-28 xl:pb-32">
                        <main class="mt-10 mx-auto max-w-7xl px-4 sm:mt-12 sm:px-6 md:mt-16 lg:mt-20 lg:px-8 xl:mt-28">
                            <div class="sm:text-center lg:text-left">
                                <h1 class="text-4xl tracking-tight font-extrabold text-gray-900 sm:text-5xl md:text-6xl"><span class="block xl:inline">The digital OS for</span> <span class="block text-green-600 xl:inline">local food economies</span></h1>
                                <p class="mt-3 text-base text-gray-500 sm:mt-5 sm:text-lg sm:max-w-xl sm:mx-auto md:mt-5 md:text-xl lg:mx-0">Agora empowers small and medium-sized farmers with intelligent tools for sales, logistics, and customer relationships, creating a resilient, transparent, and profitable local food ecosystem.</p>
                                <div class="mt-5 sm:mt-8 sm:flex sm:justify-center lg:justify-start">
                                    <div class="rounded-md shadow"><a href="#" onclick="app.navigateTo('marketplace'); return false;" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 md:py-4 md:text-lg md:px-10">Shop Local</a></div>
                                    <div class="mt-3 sm:mt-0 sm:ml-3"><a href="#" onclick="app.navigateTo('farmer-login'); return false;" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 md:py-4 md:text-lg md:px-10">I'm a Farmer</a></div>
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
                <div class="lg:absolute lg:inset-y-0 lg:right-0 lg:w-1/2"><img class="h-56 w-full object-cover sm:h-72 md:h-96 lg:w-full lg:h-full" src="https://images.unsplash.com/photo-1560493676-04071c5f467b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1974&q=80" alt="Farmer holding a crate of fresh vegetables" onerror="this.onerror=null;this.src='https://placehold.co/1000x800/a0aec0/ffffff?text=Local+Farm';"></div>
            </div>
        </div>

        <!-- Farmer Login Page -->
        <div id="farmer-login-page" class="page">
            <div class="min-h-[calc(100vh-64px)] flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
                <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-xl shadow-lg">
                    <div><h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">Select a Farmer Profile</h2></div>
                    <p class="text-center text-gray-600">For this MVP demo, please select a farm to manage.</p>
                    <div>
                        <label for="farmer-select" class="sr-only">Select a farm</label>
                        <select id="farmer-select" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-lg p-3"></select>
                    </div>
                    <div><button onclick="app.farmerLogin()" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">Access Dashboard</button></div>
                </div>
            </div>
        </div>
        
        <!-- Farmer Dashboard Page -->
        <div id="farmer-dashboard-page" class="page">
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <div id="farmer-dashboard-content" class="px-4 py-6 sm:px-0"></div>
            </div>
        </div>

        <!-- Farmer Profile Edit Page -->
        <div id="farmer-profile-edit-page" class="page">
             <div class="max-w-3xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Edit Farm Profile</h1>
                <form id="farmer-profile-form" class="bg-white p-8 rounded-lg shadow-md space-y-6"></form>
            </div>
        </div>

        <!-- Farm Profile View Page -->
        <div id="farm-profile-page" class="page">
            <div id="farm-profile-content" class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8"></div>
        </div>
        
        <!-- Add/Edit Product Page -->
        <div id="add-product-page" class="page">
            <div class="max-w-3xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
                <h1 id="product-form-title" class="text-3xl font-bold text-gray-900 mb-6">Add a New Product</h1>
                <form id="product-form" class="bg-white p-8 rounded-lg shadow-md space-y-6"></form>
            </div>
        </div>

        <!-- Marketplace Page -->
        <div id="marketplace-page" class="page">
            <div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-extrabold text-gray-900">Marketplace</h1>
                    <p class="mt-2 text-lg text-gray-600">Fresh, local food directly from the source.</p>
                </div>
                <div id="marketplace-filters" class="mb-6 p-4 bg-white rounded-lg shadow-sm flex flex-col md:flex-row gap-4 items-center sticky top-[65px] z-30"></div>
                <div id="marketplace-farm-list" class="space-y-8"></div>
            </div>
        </div>

        <!-- Events Page -->
        <div id="events-page" class="page">
            <div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-10"><h1 class="text-4xl font-extrabold tracking-tight text-gray-900">Upcoming Events</h1><p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500">Connect with your local food community.</p></div>
                <div id="events-filters" class="mb-6 p-4 bg-white rounded-lg shadow-sm flex flex-col md:flex-row gap-4 items-center sticky top-[65px] z-30"></div>
                <div id="events-list" class="space-y-12"></div>
            </div>
        </div>

        <!-- My Account, Cart, Order Confirmation Pages -->
        <div id="account-page" class="page"><div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8"><h1 class="text-3xl font-bold text-gray-900 mb-6">My Account</h1><div class="bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-semibold mb-4">Order History</h2><div id="order-history-container" class="space-y-6"></div></div></div></div>
        <div id="cart-page" class="page"><div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8"><h1 class="text-3xl font-bold text-gray-900 mb-6">Your Cart</h1><div id="cart-items-container" class="bg-white p-6 rounded-lg shadow-md"></div><div id="cart-summary" class="mt-6 bg-white p-6 rounded-lg shadow-md"></div></div></div>
        <div id="order-confirmation-page" class="page"><div class="min-h-[calc(100vh-64px)] flex items-center justify-center"><div class="text-center bg-white p-12 rounded-xl shadow-lg"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100"><svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></div><h2 class="text-2xl font-bold text-gray-900 mt-4">Order Placed!</h2><p class="text-gray-600 mt-2">You can track its status in your account.</p><div id="confirmation-details" class="text-left mt-4 border-t pt-4"></div><button onclick="app.navigateTo('marketplace')" class="mt-6 w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700">Continue Shopping</button></div></div></div>
    </main>

    <script>
    const app = {
        state: {
            farms: [],
            products: [],
            cart: [],
            orders: [],
            events: [],
            nextProductId: 1,
            nextOrderId: 1,
            loggedInFarmerId: null,
            currentUser: null,
            fulfillmentMethod: "On-Farm Pickup every Saturday, 10am-2pm",
            filters: {
                marketplace: { search: '', tags: [], sortBy: 'name' },
                events: { search: '', type: 'All' }
            }
        },

        init() {
            this.loadInitialData();
            this.setupEventListeners();
            this.updateNav();
            this.populateFarmerLogin();
            this.navigateTo('home');
        },
        
        setupEventListeners() {
            document.getElementById('mobile-menu-button').addEventListener('click', this.toggleMobileMenu);
            document.getElementById('product-form').addEventListener('submit', this.handleProductFormSubmit.bind(this));
            document.getElementById('farmer-profile-form').addEventListener('submit', this.handleProfileFormSubmit.bind(this));
        },

        loadInitialData() {
            this.state.farms = [
                { id: 1, name: "Green Valley Farm", story: "A family-run farm committed to sustainable agriculture and providing the freshest organic produce.", distance: 5.2, rating: 4.8, iconColor: 'bg-green-500' },
                { id: 2, name: "Sunrise Meadows", story: "Home to the happiest pasture-raised chickens and the most delicious eggs you'll ever taste.", distance: 12.5, rating: 4.9, iconColor: 'bg-yellow-500' },
                { id: 3, name: "Oakwood Butchery", story: "Specializing in high-quality, ethically-raised, grass-fed meats. From our pasture to your plate.", distance: 8.1, rating: 4.7, iconColor: 'bg-red-500' },
                { id: 4, name: "The Honest Loaf", story: "An artisan bakery using locally-milled grains to create delicious sourdough breads and pastries.", distance: 2.3, rating: 5.0, iconColor: 'bg-orange-500' }
            ];
            const products = [
                // Green Valley Farm
                { farmerId: 1, name: "Organic Kale", price: 3.50, unit: "bunch", tracking: "simple", status: "Available", quantity: null, category: "Vegetable", tags: ["organic", "leafy green"] },
                { farmerId: 1, name: "Heirloom Tomatoes", price: 4.00, unit: "lb", tracking: "simple", status: "Available", quantity: null, category: "Vegetable", tags: ["heirloom", "fresh"] },
                { farmerId: 1, name: "Sweet Corn", price: 1.00, unit: "ear", tracking: "simple", status: "Available", quantity: null, category: "Vegetable", tags: ["seasonal", "sweet"] },
                // Sunrise Meadows
                { farmerId: 2, name: "Pasture-Raised Eggs", price: 6.00, unit: "dozen", tracking: "detailed", status: "Available", quantity: 24, category: "Dairy & Eggs", tags: ["pasture-raised", "organic"] },
                { farmerId: 2, name: "Free-Range Chicken", price: 15.00, unit: "whole", tracking: "detailed", status: "Available", quantity: 12, category: "Meat", tags: ["pasture-raised"] },
                // Oakwood Butchery
                { farmerId: 3, name: "Grass-Fed Beef Share", price: 250.00, unit: "1/8 share", tracking: "detailed", status: "Pre-Order", quantity: 10, category: "Meat", tags: ["grass-fed", "beef"] },
                { farmerId: 3, name: "Artisanal Sausages", price: 12.00, unit: "pack", tracking: "detailed", status: "Available", quantity: 30, category: "Meat", tags: ["gluten-free"] },
                // The Honest Loaf
                { farmerId: 4, name: "Sourdough Bread", price: 8.00, unit: "loaf", tracking: "detailed", status: "Available", quantity: 15, category: "Pantry", tags: ["artisan", "bakery"] },
                { farmerId: 4, name: "Morning Buns", price: 4.50, unit: "each", tracking: "simple", status: "Available", quantity: null, category: "Pantry", tags: ["bakery", "sweet"] },
            ];
            this.state.products = products.map((p, i) => ({ ...p, id: i + 1 }));
            this.state.nextProductId = products.length + 1;
            
            this.state.events = [
                { id: 1, hostId: 1, hostType: 'farm', name: "Fall Harvest Festival", date: "October 12, 2025", description: "Join Green Valley Farm for a day of apple picking, hayrides, and live music.", featuredProductIds: [2, 3], type: "Festival" },
                { id: 2, hostId: null, hostType: 'community', name: "Downtown Farmers Market", date: "Every Saturday", description: "Your weekly stop for the freshest goods from multiple local farms.", featuredProductIds: [1, 4, 7, 8], type: "Market" },
                { id: 3, hostId: 4, hostType: 'farm', name: "Sourdough Workshop", date: "September 20, 2025", description: "Learn the art of sourdough from the experts at The Honest Loaf.", featuredProductIds: [8,9], type: "Workshop"}
            ];
        },
        
        populateFarmerLogin() {
            const select = document.getElementById('farmer-select');
            select.innerHTML = this.state.farms.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        },

        navigateTo(pageId, param = null) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(`${pageId}-page`);
            if (targetPage) targetPage.classList.add('active');
            else { console.error(`Page "${pageId}-page" not found.`); return; }
            window.scrollTo(0, 0);
            this.closeMobileMenu();

            switch(pageId) {
                case 'farmer-dashboard': this.renderFarmerDashboard(); break;
                case 'farmer-profile-edit': this.renderFarmerProfileEdit(); break;
                case 'farm-profile': this.renderFarmProfilePage(param); break;
                case 'add-product': this.renderProductForm(); break;
                case 'marketplace': this.renderMarketplace(); break;
                case 'events': this.renderEventsPage(); break;
                case 'account': this.renderAccountPage(); break;
                case 'cart': this.renderCart(); break;
            }
        },

        closeMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-button');
            if (menu.style.display !== 'none') {
                 menu.style.display = 'none';
                 btn.children[0].classList.remove('hidden');
                 btn.children[1].classList.add('hidden');
            }
        },

        toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const btn = document.getElementById('mobile-menu-button');
            const isOpen = menu.style.display === 'block';
            menu.style.display = isOpen ? 'none' : 'block';
            btn.children[0].classList.toggle('hidden', !isOpen);
            btn.children[1].classList.toggle('hidden', isOpen);
        },

        // --- USER / ACCOUNT MGMT ---
        handleAccountClick() {
            if (this.state.currentUser) this.navigateTo('account');
            else {
                this.state.currentUser = { id: 101, name: "Local Shopper" };
                this.updateNav();
                this.showNotification("You are now logged in!");
                this.navigateTo('account');
            }
        },
        updateNav() {
            const isLoggedIn = !!this.state.currentUser;
            const text = isLoggedIn ? "My Account" : "Login";
            document.getElementById('nav-account-link').textContent = text;
            document.getElementById('mobile-nav-account-link').textContent = text;
        },
        renderAccountPage() {
            const container = document.getElementById('order-history-container');
            if (!this.state.currentUser) {
                 container.innerHTML = `<p>Please log in to see your orders.</p>`;
                 return;
            }
            const userOrders = this.state.orders.filter(o => o.userId === this.state.currentUser.id);
            if (userOrders.length === 0) {
                 container.innerHTML = `<p>You have not placed any orders yet.</p>`;
                 return;
            }
            container.innerHTML = userOrders.slice().reverse().map(order => this.getOrderCardHTML(order, 'user')).join('');
        },
        
        // --- FARMER PORTAL ---
        farmerLogin() {
            const selectedId = document.getElementById('farmer-select').value;
            this.state.loggedInFarmerId = parseInt(selectedId);
            this.navigateTo('farmer-dashboard');
        },

        renderFarmerDashboard() {
            if (!this.state.loggedInFarmerId) return;
            const farmer = this.state.farms.find(f => f.id === this.state.loggedInFarmerId);
            const content = document.getElementById('farmer-dashboard-content');
            
            const farmerProducts = this.state.products.filter(p => p.farmerId === this.state.loggedInFarmerId);
            const productListHTML = farmerProducts.length > 0 ? farmerProducts.map(p => this.getFarmerProductCardHTML(p)).join('') : `<p class="text-gray-500 col-span-full">No products yet.</p>`;

            const farmerOrders = this.state.orders.filter(o => this.getFarmIdFromOrder(o) === this.state.loggedInFarmerId);
            const orderListHTML = farmerOrders.length > 0 ? `<ul class="divide-y divide-gray-200">${farmerOrders.slice().reverse().map(order => this.getOrderCardHTML(order, 'farmer')).join('')}</ul>` : '<p class="text-gray-500 p-4">No orders received yet.</p>';

            content.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h1 class="text-3xl font-bold text-gray-900">${farmer.name} Dashboard</h1>
                    <div>
                        <button onclick="app.navigateTo('farmer-profile-edit')" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md shadow-sm text-gray-700 bg-white hover:bg-gray-50 mr-2">Edit Profile</button>
                        <button onclick="app.navigateTo('add-product')" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">Add New Product</button>
                    </div>
                </div>
                <h2 class="text-2xl font-semibold mb-4">My Products</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${productListHTML}</div>
                <div class="mt-10"><h2 class="text-2xl font-semibold mb-4">Recent Orders</h2><div class="bg-white shadow overflow-hidden sm:rounded-md">${orderListHTML}</div></div>`;
        },

        getFarmIdFromOrder(order) {
            if (!order.items || order.items.length === 0) return null;
            const firstProductId = order.items[0].id;
            const product = this.state.products.find(p => p.id === firstProductId);
            return product ? product.farmerId : null;
        },

        renderFarmerProfileEdit() {
            const farmer = this.state.farms.find(f => f.id === this.state.loggedInFarmerId);
            const form = document.getElementById('farmer-profile-form');
            form.innerHTML = `
                <input type="hidden" id="farm-id" value="${farmer.id}">
                <div><label for="farm-name" class="block text-sm font-medium text-gray-700">Farm Name</label><input type="text" id="farm-name" class="mt-1 block w-full rounded-md" value="${farmer.name}" required></div>
                <div><label for="farm-story" class="block text-sm font-medium text-gray-700">Our Story</label><textarea id="farm-story" rows="4" class="mt-1 block w-full rounded-md">${farmer.story}</textarea></div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="app.navigateTo('farmer-dashboard')" class="bg-white py-2 px-4 border rounded-md">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md">Save Profile</button>
                </div>`;
        },

        handleProfileFormSubmit(event) {
            event.preventDefault();
            const farmId = parseInt(document.getElementById('farm-id').value);
            const farm = this.state.farms.find(f => f.id === farmId);
            farm.name = document.getElementById('farm-name').value;
            farm.story = document.getElementById('farm-story').value;
            this.showNotification('Profile updated successfully!');
            this.navigateTo('farmer-dashboard');
        },

        // --- Farm Profile Page ---
        renderFarmProfilePage(farmId) {
            const farm = this.state.farms.find(f => f.id === farmId);
            if (!farm) { this.navigateTo('marketplace'); return; }

            const products = this.state.products.filter(p => p.farmerId === farmId && p.status !== 'Sold Out');
            const productsByCategory = products.reduce((acc, p) => {
                if (!acc[p.category]) acc[p.category] = [];
                acc[p.category].push(p);
                return acc;
            }, {});

            const productHTML = Object.entries(productsByCategory).map(([category, prods]) => `
                <h3 class="text-2xl font-bold text-gray-800 mt-6 mb-4">${category}</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">${prods.map(p => this.getProductCardHTML(p)).join('')}</div>
            `).join('');

            const content = document.getElementById('farm-profile-content');
            content.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 ${farm.iconColor} rounded-full flex items-center justify-center text-white text-3xl font-bold">${farm.name.charAt(0)}</div>
                        <div>
                            <h1 class="text-4xl font-extrabold text-gray-900">${farm.name}</h1>
                            <p class="text-gray-600">${farm.distance} km away | ${farm.rating} ★</p>
                        </div>
                    </div>
                    <p class="mt-6 text-lg text-gray-700">${farm.story}</p>
                    <div class="mt-8 border-t pt-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-6">Our Products</h2>
                        ${productHTML || '<p>No products currently available from this farm.</p>'}
                    </div>
                </div>`;
        },
        
        // --- Product Form ---
        renderProductForm(productId = null) {
            const product = productId ? this.state.products.find(p => p.id === productId) : null;
            document.getElementById('product-form-title').innerText = product ? 'Edit Product' : 'Add New Product';
            const form = document.getElementById('product-form');
            form.innerHTML = `
                <input type="hidden" id="product-id" value="${product?.id || ''}">
                <div><label for="product-name" class="block text-sm font-medium text-gray-700">Product Name</label><input type="text" id="product-name" value="${product?.name || ''}" class="mt-1 block w-full rounded-md" required></div>
                <div><label for="product-category" class="block text-sm font-medium text-gray-700">Category</label><select id="product-category" class="mt-1 block w-full rounded-md"><option>Vegetable</option><option>Fruit</option><option>Meat</option><option>Dairy & Eggs</option><option>Pantry</option></select></div>
                <div><label for="product-tags" class="block text-sm font-medium text-gray-700">Tags (comma-separated)</label><input type="text" id="product-tags" value="${product?.tags.join(', ') || ''}" placeholder="e.g. organic, gluten-free" class="mt-1 block w-full rounded-md"></div>
                <div><label for="product-price" class="block text-sm font-medium text-gray-700">Price</label><input type="number" step="0.01" id="product-price" value="${product?.price?.toFixed(2) || ''}" class="mt-1 block w-full rounded-md" placeholder="0.00" required></div>
                <div><label for="product-unit" class="block text-sm font-medium text-gray-700">Unit</label><input type="text" id="product-unit" value="${product?.unit || ''}" class="mt-1 block w-full rounded-md" placeholder="e.g. lb, bunch" required></div>
                <fieldset class="space-y-4"><legend class="text-base font-medium">Inventory Tracking</legend>
                    <div class="flex items-center"><input id="tracking-detailed" name="tracking-method" type="radio" value="detailed" class="h-4 w-4" ${product?.tracking !== 'simple' ? 'checked' : ''}><label for="tracking-detailed" class="ml-3 block text-sm font-medium">Detailed (Quantity-Based)</label></div>
                    <div class="flex items-center"><input id="tracking-simple" name="tracking-method" type="radio" value="simple" class="h-4 w-4" ${product?.tracking === 'simple' ? 'checked' : ''}><label for="tracking-simple" class="ml-3 block text-sm font-medium">Simple (Status-Based)</label></div>
                </fieldset>
                <div id="detailed-tracking-fields"><label for="product-quantity" class="block text-sm font-medium">Quantity</label><input type="number" id="product-quantity" value="${product?.quantity || ''}" class="mt-1 block w-full rounded-md"></div>
                <div id="simple-tracking-fields"><label for="product-status-manual" class="block text-sm font-medium">Status</label><select id="product-status-manual" class="mt-1 block w-full rounded-md"><option>Available</option><option>Sold Out</option><option>Pre-Order</option></select></div>
                <div class="flex justify-end space-x-3"><button type="button" onclick="app.navigateTo('farmer-dashboard')" class="bg-white py-2 px-4 border rounded-md">Cancel</button><button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md">Save</button></div>`;
            
            if (product) {
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-status-manual').value = product.status;
            }
            this.handleTrackingMethodChange(); // Set initial state
            document.querySelectorAll('input[name="tracking-method"]').forEach(radio => radio.addEventListener('change', this.handleTrackingMethodChange));
        },
        handleProductFormSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('product-id').value;
            const trackingMethod = document.querySelector('input[name="tracking-method"]:checked').value;

            const productData = {
                name: document.getElementById('product-name').value,
                price: parseFloat(document.getElementById('product-price').value),
                unit: document.getElementById('product-unit').value,
                category: document.getElementById('product-category').value,
                tags: document.getElementById('product-tags').value.split(',').map(t => t.trim()).filter(Boolean),
                tracking: trackingMethod,
                farmerId: this.state.loggedInFarmerId,
            };

            if (trackingMethod === 'detailed') {
                productData.quantity = parseInt(document.getElementById('product-quantity').value);
                productData.status = productData.quantity > 0 ? 'Available' : 'Sold Out';
            } else {
                productData.quantity = null;
                productData.status = document.getElementById('product-status-manual').value;
            }

            if (id) {
                const index = this.state.products.findIndex(p => p.id == id);
                this.state.products[index] = { ...this.state.products[index], ...productData };
                this.showNotification('Product updated!');
            } else {
                productData.id = this.state.nextProductId++;
                this.state.products.push(productData);
                this.showNotification('Product added!');
            }

            document.getElementById('product-form').reset();
            this.navigateTo('farmer-dashboard');
        },

        // --- MARKETPLACE & EVENTS ---
        handleFilterChange(page, type, value) {
            this.state.filters[page][type] = value;
            if (page === 'marketplace') this.renderMarketplace();
            if (page === 'events') this.renderEventsPage();
        },
        renderMarketplace() {
            const container = document.getElementById('marketplace-farm-list');
            const filtersContainer = document.getElementById('marketplace-filters');
            const { search, tags, sortBy } = this.state.filters.marketplace;

            // Render filters
            const allTags = [...new Set(this.state.products.flatMap(p => p.tags))];
            filtersContainer.innerHTML = `
                <input type="text" oninput="app.handleFilterChange('marketplace', 'search', this.value)" value="${search}" placeholder="Search farms or products..." class="w-full md:w-1/3 rounded-md border-gray-300">
                <select onchange="app.handleFilterChange('marketplace', 'sortBy', this.value)" class="w-full md:w-auto rounded-md border-gray-300">
                    <option value="name" ${sortBy === 'name' ? 'selected' : ''}>Sort by Name</option>
                    <option value="distance" ${sortBy === 'distance' ? 'selected' : ''}>Sort by Distance</option>
                    <option value="rating" ${sortBy === 'rating' ? 'selected' : ''}>Sort by Rating</option>
                </select>
                <div class="flex-grow flex flex-wrap gap-2 justify-center">${allTags.map(tag => `<button onclick="app.toggleTagFilter('${tag}')" class="${tags.includes(tag) ? 'bg-green-600 text-white' : 'bg-gray-200'} px-3 py-1 rounded-full text-sm">${tag}</button>`).join('')}</div>`;

            // Filter and sort farms
            let filteredFarms = this.state.farms.map(farm => {
                const farmProducts = this.state.products.filter(p => p.farmerId === farm.id);
                const matchesSearch = farm.name.toLowerCase().includes(search.toLowerCase()) || farmProducts.some(p => p.name.toLowerCase().includes(search.toLowerCase()));
                const matchesTags = tags.length === 0 || farmProducts.some(p => tags.every(t => p.tags.includes(t)));
                return (matchesSearch && matchesTags) ? farm : null;
            }).filter(Boolean);

            filteredFarms.sort((a, b) => {
                if (sortBy === 'distance') return a.distance - b.distance;
                if (sortBy === 'rating') return b.rating - a.rating;
                return a.name.localeCompare(b.name);
            });

            // Render farm list
            container.innerHTML = filteredFarms.map(farm => this.getFarmSectionHTML(farm)).join('') || `<p class="text-center text-gray-500">No farms match your criteria.</p>`;
        },
        
        toggleTagFilter(tag) {
            const tags = this.state.filters.marketplace.tags;
            const index = tags.indexOf(tag);
            if (index > -1) tags.splice(index, 1);
            else tags.push(tag);
            this.renderMarketplace();
        },
        
        getFarmSectionHTML(farm) {
            const products = this.state.products.filter(p => p.farmerId === farm.id && p.status !== 'Sold Out');
            const productsByCategory = products.reduce((acc, p) => {
                if (!acc[p.category]) acc[p.category] = [];
                acc[p.category].push(p);
                return acc;
            }, {});

            const productHTML = Object.entries(productsByCategory).map(([category, prods]) => `
                <h3 class="text-xl font-bold text-gray-800 mt-4 mb-2">${category}</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">${prods.map(p => this.getProductCardHTML(p)).join('')}</div>
            `).join('');

            return `
            <div class="farm-section bg-white rounded-lg shadow-md expanded" id="farm-${farm.id}">
                <div class="p-4 flex justify-between items-center cursor-pointer" onclick="app.toggleFarmSection(${farm.id})">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 ${farm.iconColor} rounded-full flex items-center justify-center text-white text-2xl font-bold">${farm.name.charAt(0)}</div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 hover:text-green-600" onclick="event.stopPropagation(); app.navigateTo('farm-profile', ${farm.id})">${farm.name}</h2>
                            <p class="text-gray-600">${farm.distance} km away | ${farm.rating} ★</p>
                        </div>
                    </div>
                    <svg class="w-6 h-6 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
                <div class="farm-product-group p-4 border-t">${productHTML || '<p>No products currently available.</p>'}</div>
            </div>`;
        },
        toggleFarmSection(farmId) {
            document.getElementById(`farm-${farmId}`).classList.toggle('expanded');
        },

        renderEventsPage() {
             const { search, type } = this.state.filters.events;
            
            const allTypes = ['All', ...new Set(this.state.events.map(e => e.type))];
            document.getElementById('events-filters').innerHTML = `
                <input type="text" oninput="app.handleFilterChange('events', 'search', this.value)" value="${search}" placeholder="Search events..." class="w-full md:w-1/2 rounded-md border-gray-300">
                <select onchange="app.handleFilterChange('events', 'type', this.value)" class="w-full md:w-auto rounded-md border-gray-300">
                    ${allTypes.map(t => `<option value="${t}" ${type === t ? 'selected' : ''}>${t}</option>`).join('')}
                </select>`;
            
            const filteredEvents = this.state.events.filter(event => {
                const matchesSearch = event.name.toLowerCase().includes(search.toLowerCase()) || event.description.toLowerCase().includes(search.toLowerCase());
                const matchesType = type === 'All' || event.type === type;
                return matchesSearch && matchesType;
            });

            document.getElementById('events-list').innerHTML = filteredEvents.map(event => this.getEventCardHTML(event)).join('') || `<p class="text-center text-gray-500">No events match your criteria.</p>`;
        },
        
        getEventCardHTML(event) {
            let hostName = "Community Event";
            if (event.hostType === 'farm') {
                const farm = this.state.farms.find(f => f.id === event.hostId);
                if (farm) hostName = farm.name;
            }
            const featuredProductsHTML = event.featuredProductIds.map(id => this.state.products.find(p => p.id === id)).filter(Boolean).map(p => this.getProductCardHTML(p, 'event')).join('');
            return `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="p-6">
                        <p class="text-sm font-semibold text-green-600">${hostName}</p>
                        <h2 class="text-2xl font-bold text-gray-900 mt-1">${event.name}</h2>
                        <p class="text-md font-medium text-gray-500">${event.date} | <span class="font-bold">${event.type}</span></p>
                        <p class="mt-3 text-gray-600">${event.description}</p>
                    </div>
                    <div class="p-6 bg-gray-50"><h3 class="text-lg font-semibold mb-4">Featured Products</h3><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${featuredProductsHTML || '<p>No featured products.</p>'}</div></div>
                </div>`;
        },
        
        // --- CART & CHECKOUT ---
        addToCart(productId) {
            const product = this.state.products.find(p => p.id === productId);
            if (!product || product.status !== 'Available') {
                this.showNotification('This product is not available.', 'error');
                return;
            }
            const cartItem = this.state.cart.find(item => item.id === productId);
            if (product.tracking === 'detailed') {
                const quantityInCart = cartItem ? cartItem.quantity : 0;
                if (quantityInCart >= product.quantity) {
                    this.showNotification('No more stock available.', 'error');
                    return;
                }
            }
            if (cartItem) { cartItem.quantity++; } 
            else { this.state.cart.push({ ...product, quantity: 1 }); }
            
            this.updateCartCount();
            this.showNotification(`${product.name} added to cart.`);
        },

        renderCart() {
            const container = document.getElementById('cart-items-container');
            const summaryContainer = document.getElementById('cart-summary');
            container.innerHTML = '';
            summaryContainer.innerHTML = '';

            if (this.state.cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Your cart is empty.</p>';
                return;
            }

            let subtotal = 0;
            const cartTable = document.createElement('ul');
            cartTable.className = 'divide-y divide-gray-200';

            this.state.cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                const li = document.createElement('li');
                li.className = 'py-4 flex items-center justify-between flex-wrap';
                li.innerHTML = `
                    <div class="flex-grow mb-2 sm:mb-0">
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-gray-600">$${item.price.toFixed(2)} / ${item.unit}</p>
                    </div>
                    <div class="flex items-center w-full sm:w-auto">
                        <input type="number" value="${item.quantity}" onchange="app.updateCartQuantity(${item.id}, this.value)" min="1" ${item.tracking === 'detailed' && item.status === 'Available' ? `max="${item.quantity}"` : ''} class="w-16 text-center border-gray-300 rounded-md shadow-sm">
                        <p class="w-24 text-right font-semibold">$${itemTotal.toFixed(2)}</p>
                        <button onclick="app.removeFromCart(${item.id})" class="ml-4 text-red-500 hover:text-red-700 text-2xl font-bold">&times;</button>
                    </div>
                `;
                cartTable.appendChild(li);
            });

            container.appendChild(cartTable);
            
            summaryContainer.innerHTML = `
                <h2 class="text-lg font-semibold mb-4">Order Summary</h2>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Subtotal</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between font-bold text-xl border-t pt-2 mt-2">
                        <span>Total</span>
                        <span>$${subtotal.toFixed(2)}</span>
                    </div>
                </div>
                <div class="mt-6">
                    <h3 class="font-semibold">Fulfillment</h3>
                    <p class="text-gray-600">${this.state.fulfillmentMethod}</p>
                </div>
                <button onclick="app.checkout()" class="mt-6 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-md hover:bg-green-700 focus:outline-none">
                    Proceed to Checkout
                </button>
            `;
        },

        updateCartQuantity(productId, newQuantity) {
            const quantity = parseInt(newQuantity);
            const cartItem = this.state.cart.find(item => item.id === productId);
            if (!cartItem) return;

            const product = this.state.products.find(p => p.id === productId);
            let maxQuantity = Infinity;
            if (product && product.tracking === 'detailed') {
                maxQuantity = product.quantity;
            }

            if (quantity <= 0) {
                this.removeFromCart(productId);
            } else {
                cartItem.quantity = Math.min(quantity, maxQuantity);
            }
            this.updateCartCount();
            this.renderCart();
        },

        removeFromCart(productId) {
            this.state.cart = this.state.cart.filter(item => item.id !== productId);
            this.updateCartCount();
            this.renderCart();
            this.showNotification('Item removed from cart.');
        },

        checkout() {
             if (!this.state.currentUser) {
                this.showNotification("Please log in to check out.", 'error');
                this.handleAccountClick(); // Prompt login
                return;
            }
            if (this.state.cart.length === 0) {
                this.showNotification('Your cart is empty.', 'error'); return;
            }
            const order = {
                id: this.state.nextOrderId++,
                userId: this.state.currentUser.id,
                items: [...this.state.cart],
                total: this.state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                status: 'New',
                date: new Date().toLocaleDateString()
            };
            this.state.orders.push(order);

             order.items.forEach(cartItem => {
                const product = this.state.products.find(p => p.id === cartItem.id);
                if (product && product.tracking === 'detailed') {
                    product.quantity -= cartItem.quantity;
                    if (product.quantity <= 0) product.status = 'Sold Out';
                }
            });
            this.renderOrderConfirmation(order);
            this.navigateTo('order-confirmation');
            this.state.cart = [];
            this.updateCartCount();
        },
        renderOrderConfirmation(order) {
            const detailsContainer = document.getElementById('confirmation-details');
            let itemsHtml = order.items.map(item => `
                <div class="flex justify-between py-1">
                    <span>${item.name} (x${item.quantity})</span>
                    <span>$${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            `).join('');

            detailsContainer.innerHTML = `
                <p><strong>Order ID:</strong> #${order.id}</p>
                <p><strong>Total:</strong> <span class="font-bold">$${order.total.toFixed(2)}</span></p>
                <p class="mt-2"><strong>Fulfillment Details:</strong></p>
                <p class="text-gray-700">${this.state.fulfillmentMethod}</p>
                <div class="mt-4 border-t pt-2">${itemsHtml}</div>
            `;
        },

        // --- HTML TEMPLATES & UTILITIES ---
        getProductCardHTML(product, context = 'marketplace') {
            const statusColor = this.getStatusColor(product.status);
            const farm = this.state.farms.find(f => f.id === product.farmerId);
            const isAvailable = product.status === 'Available';
            const buttonClass = context === 'event' ? 'py-1 px-3 text-sm' : 'py-2 px-4 font-bold';
            
            return `
            <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col border border-gray-200">
                <div class="p-4 flex-grow">
                    <span class="text-xs font-semibold ${statusColor.text} ${statusColor.bg} px-2 py-1 rounded-full">${product.status}</span>
                    <h3 class="text-lg font-bold text-gray-900 mt-2">${product.name}</h3>
                    <p class="text-sm text-gray-500">${farm.name}</p>
                    <p class="mt-2 text-xl font-bold text-gray-800">$${product.price.toFixed(2)} <span class="text-base font-normal text-gray-600">/ ${product.unit}</span></p>
                    ${product.tracking === 'detailed' ? `<p class="text-sm text-red-600 mt-1">${product.quantity} left in stock</p>` : ''}
                    <div class="mt-2 flex flex-wrap gap-1">${product.tags.map(t => `<span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full">${t}</span>`).join('')}</div>
                </div>
                <div class="p-4 bg-gray-50">
                    <button onclick="app.addToCart(${product.id})" class="w-full bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed ${buttonClass}" ${!isAvailable ? 'disabled' : ''}>
                        ${isAvailable ? 'Add to Cart' : 'Unavailable'}
                    </button>
                </div>
            </div>`;
        },
        getFarmerProductCardHTML(product) {
            const statusColor = this.getStatusColor(product.status);
            return `
                <div class="bg-white rounded-lg shadow-md p-4 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-bold">${product.name}</h3>
                            <span class="text-sm font-semibold ${statusColor.text} ${statusColor.bg} px-2 py-1 rounded-full">${product.status}</span>
                        </div>
                        <p class="text-gray-600">$${product.price.toFixed(2)} / ${product.unit}</p>
                        <p class="text-sm text-gray-500 mt-2">
                            Tracking: <span class="font-medium">${product.tracking === 'detailed' ? `Detailed (${product.quantity} left)` : 'Simple'}</span>
                        </p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200 flex space-x-2">
                        <button onclick="app.navigateTo('add-product', ${product.id})" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-1 px-3 rounded-md w-full">Edit</button>
                        ${product.tracking === 'simple' ? `
                            <button onclick="app.toggleProductStatus(${product.id})" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium py-1 px-3 rounded-md w-full">Toggle Status</button>
                        ` : ''}
                    </div>
                </div>
            `;
        },
        getOrderCardHTML(order, perspective) {
            const itemsSummary = order.items.map(i => `${i.name} (x${i.quantity})`).join(', ');
            const statusColor = this.getOrderStatusColor(order.status);
            const statuses = ['New', 'Processing', 'Ready for Pickup', 'Fulfilled', 'Cancelled'];

            const farmerControls = perspective === 'farmer' ? `
                <div class="mt-4 pt-4 border-t">
                    <label for="status-select-${order.id}" class="text-sm font-medium text-gray-600">Update Status:</label>
                    <select id="status-select-${order.id}" onchange="app.updateOrderStatus(${order.id}, this.value)" class="ml-2 rounded-md border-gray-300 shadow-sm text-sm">
                        ${statuses.map(s => `<option value="${s}" ${s === order.status ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </div>
            ` : '';

             return `
            <li class="bg-white p-4 my-2 rounded-lg border border-gray-200">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                    <div>
                        <p class="text-sm font-semibold text-green-700">Order #${order.id}</p>
                        <p class="text-gray-600 text-sm">Date: ${order.date}</p>
                    </div>
                    <div class="text-left sm:text-right mt-2 sm:mt-0">
                        <p class="text-lg font-bold">$${order.total.toFixed(2)}</p>
                        <span class="text-xs font-semibold ${statusColor.text} ${statusColor.bg} px-2 py-1 rounded-full">${order.status}</span>
                    </div>
                </div>
                <div class="mt-4 border-t pt-2">
                    <p class="text-sm text-gray-800">${itemsSummary}</p>
                </div>
                ${farmerControls}
            </li>`;
        },
        getStatusColor(status) {
            switch (status) {
                case 'Available': return { text: 'text-green-800', bg: 'bg-green-100' };
                case 'Sold Out': return { text: 'text-red-800', bg: 'bg-red-100' };
                case 'Pre-Order': return { text: 'text-yellow-800', bg: 'bg-yellow-100' };
                default: return { text: 'text-gray-800', bg: 'bg-gray-100' };
            }
        },
        getOrderStatusColor(status) {
            switch (status) {
                case 'New': return { text: 'text-blue-800', bg: 'bg-blue-100' };
                case 'Processing': return { text: 'text-yellow-800', bg: 'bg-yellow-100' };
                case 'Ready for Pickup': return { text: 'text-purple-800', bg: 'bg-purple-100' };
                case 'Fulfilled': return { text: 'text-green-800', bg: 'bg-green-100' };
                case 'Cancelled': return { text: 'text-red-800', bg: 'bg-red-100' };
                default: return { text: 'text-gray-800', bg: 'bg-gray-100' };
            }
        },
        showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const notification = document.createElement('div');
            notification.className = `notification ${bgColor} text-white font-bold py-2 px-4 rounded-lg shadow-lg mb-2`;
            notification.textContent = message;
            area.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 4000);
        },
        updateCartCount() {
            const totalItems = this.state.cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-item-count').textContent = totalItems;
            document.getElementById('mobile-cart-item-count').textContent = totalItems;
        },
        handleTrackingMethodChange() {
            const method = document.querySelector('input[name="tracking-method"]:checked')?.value;
            if (!method) return;
            document.getElementById('detailed-tracking-fields').style.display = method === 'detailed' ? 'block' : 'none';
            document.getElementById('simple-tracking-fields').style.display = method === 'simple' ? 'block' : 'none';
        },
    };

    window.onload = () => { app.init(); };
    </script>
</body>
</html>

